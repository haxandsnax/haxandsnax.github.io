<!DOCTYPE html>
<html>
<head> 
  <title>Twitch VOD Info Exporter</title>
</head>
<body>
  <div><input type="text" onchange="window.userName = this.value" placeholder="Username" value="SelectingStart" /></div>
  <div><button onclick="window.fetchVods()">Download VOD Info</button></div>
  
  <script type="text/javascript">
  let vodPromises = []
  window.fetchWithHeaders = (url) => {
    return fetch(url, {headers: {'Client-Id': window.clientId}})
  }
  
  window.getVodsFromCursor = (cursor) => {
    return window.fetchWithHeaders(`https://api.twitch.tv/helix/videos?user_id=${user.id}&type=archive&after=${cursor}`)
      .then(d => d.json())
      .then(resp => {
        window.vodPromises.push(window.processVods(resp.data))
        if(resp.data.length > 0)
          window.vodPromises.push(window.getVodsFromCursor(resp.pagination.cursor))
        else
          Promise.all(window.vodPromises).then(vods => { console.log(vods) })
      })
  }
  
  window.fetchVods = () => {
    window.vodPromises = []
    fetchWithHeaders(`https://api.twitch.tv/helix/users?login=${window.userName}`)
      .then(d => d.json())
      .then(d => d.data[0])
      .then(user => {
        let vods = []
        fetchWithHeaders(`https://api.twitch.tv/helix/videos?user_id=${user.id}&type=archive`)
          .then(d => d.json())
          .then(resp => {
            let cursor = resp.pagination.cursor
            window.vodPromises.push(window.processVods(resp.data))
            if(resp.data.length > 0)
              window.vodPromises.push(window.getVodsFromCursor(resp.pagination.cursor))
          })
        }

      })
    }
    
    window.processVods = (vods) => {
      return new Promise((res, rej) => {
        res(vods.map(v => `${v.id},${v.created_at},${v.title},${v.duration}`))
      })
    }
    const clientId = 'dxvgc1lhpfm4uuu7i2o7enuy9l1pa6'
    let userName = 'SelectingStart'
    
  </script>
</body>
</html>
